{% extends layout_path %}
{% load static %}
{% load i18n %}
{% load stream_filters %}
{% block vendor_css %}
{{ block.super }}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
<script src="{% static 'vendor/libs/rateyo/rateyo.js' %}"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
{% endblock %} {% block page_css %} {{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/css/pages/app-ecommerce.css' %}" />
{% endblock %} {% block content %}
<div class="card">
  <h5 class="card-header">Tespit Listesi</h5>
  <div class="card-datatable table-responsive">
    <div class="row mb-3 px-4 pt-2">
      <!-- Search Box -->
      <div class="col-md-3">
        <input type="text" id="searchBox" class="form-control" placeholder="Ara..." />
      </div>

      <!-- Filters -->
      <div class="col-md-9">
        <div class="d-flex align-items-center">
          <div class="form-check me-3">
            <input class="form-check-input" type="checkbox" id="showAllFrames" />
            <label class="form-check-label" for="showAllFrames">Tüm Frame'ler</label>
          </div>
          <select class="form-select me-3" id="detectionType" style="width: 200px">
            <option value="">Tespit Türü Seçin</option>
            <option value="person">İnsan</option>
            <option value="vehicle">Araç</option>
            <option value="animal">Hayvan</option>
            <option value="object">Nesne</option>
          </select>
          <input type="date" class="form-control me-2" id="startDate" style="width: 150px">
          <input type="date" class="form-control" id="endDate" style="width: 150px">
        </div>
      </div>
    </div>

    <!-- Results Table -->
    <table class="table" id="detectionsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tarih</th>
          <th>Tespit Türü</th>
          <th>Kamera</th>
          <th>Frame</th>
          <th>İşlemler</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table content will be populated dynamically -->
      </tbody>
    </table>
  </div>
</div>

<style>
.btn-expand i {
  transition: transform 0.2s;
}

</style>

<script>
const streamImagesData = [{
  %
  for image in stream_images %
} {
  id: {
    {
      image.id
    }
  },
  imageUrl: "https://atasehir.algi.ai{{ image.image.url|escapejs }}",
  detections: [{
    %
    for detection in image.detections.all %
  } {
    x_min: {
      {
        detection.x_min
      }
    },
    y_min: {
      {
        detection.y_min
      }
    },
    x_max: {
      {
        detection.x_max
      }
    },
    y_max: {
      {
        detection.y_max
      }
    },
    className: "{{ detection.class_name|escapejs }}"
  } {
    %
    if not forloop.last %
  }, {
    %
    endif %
  } {
    %
    endfor %
  }]
} {
  %
  if not forloop.last %
}, {
  %
  endif %
} {
  %
  endfor %
}];

window.addEventListener('load', function() {
  streamImagesData.forEach(function(imageData) {
    const modal = document.getElementById('imageModal-' + imageData.id);
    if (modal) {
      modal.addEventListener('shown.bs.modal', function() {
        // Create a new canvas instance
        var canvas = new fabric.Canvas('canvas-' + imageData.id);

        // Load the image
        fabric.Image.fromURL(imageData.imageUrl, function(img) {
          // Calculate the scaling to fit the modal
          const modalWidth = modal.querySelector('.modal-body').clientWidth;
          const scale = modalWidth / img.width;

          // Set canvas dimensions
          canvas.setWidth(img.width * scale);
          canvas.setHeight(img.height * scale);

          // Scale the image
          img.scale(scale);

          // Center the image
          canvas.add(img);
          canvas.centerObject(img);

          // Add detections with scaled coordinates
          imageData.detections.forEach(function(detection) {
            var rect = new fabric.Rect({
              left: detection.x_min * scale,
              top: detection.y_min * scale,
              width: (detection.x_max - detection.x_min) * scale,
              height: (detection.y_max - detection.y_min) * scale,
              fill: 'transparent',
              stroke: 'red',
              strokeWidth: 2,
              selectable: false
            });

            var text = new fabric.Text(detection.className, {
              left: detection.x_min * scale,
              top: (detection.y_min * scale) - 15,
              fontSize: 12 * scale,
              fill: 'red',
              fontFamily: 'Arial',
              selectable: false
            });

            canvas.add(rect);
            canvas.add(text);
          });

          canvas.renderAll();
        });
      });

      // Clean up canvas when modal is hidden
      modal.addEventListener('hidden.bs.modal', function() {
        var canvas = new fabric.Canvas('canvas-' + imageData.id);
        canvas.dispose();
      });
    }
  });
});

document.addEventListener('DOMContentLoaded', function() {
  const searchBox = document.getElementById('searchBox');
  const detectionType = document.getElementById('detectionType');
  const showAllFrames = document.getElementById('showAllFrames');
  const startDate = document.getElementById('startDate');
  const endDate = document.getElementById('endDate');

  function updateResults() {
    // Add logic to fetch and update results based on filters
  }

  searchBox.addEventListener('input', updateResults);
  detectionType.addEventListener('change', updateResults);
  showAllFrames.addEventListener('change', updateResults);
  startDate.addEventListener('change', updateResults);
  endDate.addEventListener('change', updateResults);
});

</script>

{% endblock %}
